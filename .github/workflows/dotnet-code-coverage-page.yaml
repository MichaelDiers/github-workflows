# Info:
# - uses altcover for code coverage
# Usage:
# - set initial data in csproj:
# -- set Version
# 
# name: <name of the workflow>
# on:
#   push:
#     paths:
#       - <path>
#   workflow_dispatch:
# jobs:
#   create-code-coverage-page:
#     uses: MichaelDiers/github-workflows/.github/workflows/dotnet-code-coverage-page.yaml@main
#     with:
#       project-name: <name of the project without .csproj>
#       test-project-name: <name of the test project without .csproj>
#       solution-directory: <path to the folder that contains the solution file>
#
name: add code coverage results to github pages
on:
  workflow_call:
    inputs:
      project-name:
        required: true
        type: string
      test-project-name:
        required: true
        type: string
      solution-directory:
        required: true
        type: string
permissions:
  contents: read
  pages: write
jobs:
  extract-version:
    uses: MichaelDiers/github-workflows/.github/workflows/dotnet-project-version.yaml@main
    with:
      project-path: ${{inputs.solution-directory}}/${{inputs.project-name}}/${{inputs.project-name}}.csproj
  coverage:
    needs: extract-version
    runs-on: ubuntu-latest
    env:
      ALTCOVER_XML: doc/coverage/${{inputs.test-project-name}}-altcover.xml
      SOLUTION_DIRECTORY: ${{inputs.solution-directory}}
      TEST_CSPROJ: ${{inputs.solution-directory}}/${{inputs.test-project-name}}/${{inputs.test-project-name}}.csproj
      REPORT_TARGET: doc/coverage
      ASSEMBLY_FILTERS: -*.Tests;-AltCover.Monitor
      REPORT_TITLE: ${{inputs.project-name}} ${{needs.extract-version.outputs.version}} Code Coverage
    steps:
    - name: checkout
      uses: actions/checkout@v3
    - name: add altcover
      run: dotnet add ${{env.TEST_CSPROJ}} package altcover
    - name: build
      run: dotnet build --configuration Release 
      working-directory: ${{env.SOLUTION_DIRECTORY}}
    - name: test
      run: dotnet test --configuration Release /p:AltCover=true --no-build --no-restore /p:AltCoverReport="../../${{ env.ALTCOVER_XML }}" /p:AltCoverAssemblyFilter=xunit.*
      working-directory: ${{env.SOLUTION_DIRECTORY}}
    - name: Setup .NET Core
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 6.x
        dotnet-quality: 'ga'
    - name: ReportGenerator
      uses: danielpalme/ReportGenerator-GitHub-Action@5.1.26
      with:
        reports: ${{ env.ALTCOVER_XML }}
        targetdir: ${{ env.REPORT_TARGET }}
        reporttypes: Html_Dark
        assemblyfilters: ${{ env.ASSEMBLY_FILTERS }}
        title: ${{env.REPORT_TITLE}}
    - name: Setup Pages
      uses: actions/configure-pages@v3
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v2
      with:
        path: ${{ env.REPORT_TARGET }}
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v2
